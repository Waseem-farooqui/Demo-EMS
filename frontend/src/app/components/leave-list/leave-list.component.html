<div class="leave-list-container">
  <div class="page-header">
    <h2>Leave Management</h2>
    <p class="subtitle" *ngIf="isSuperAdmin">Review and manage all leave requests</p>
    <div class="header-actions">
      <!-- Back button when viewing employee leaves -->
      <button *ngIf="!showEmployeeListView && isAdmin" (click)="backToEmployeeList()" class="btn btn-secondary">
        <span>‚Üê</span> Back to Employees
      </button>
      <!-- Apply Leave button (for regular users or when not in employee list view) -->
      <a *ngIf="!isSuperAdmin && (!isAdmin || !showEmployeeListView)" routerLink="/leaves/apply" class="btn btn-primary">
        <span>üìù</span> Apply Leave
      </a>
    </div>
  </div>

  <!-- Employee List View (for Admin/Super Admin) -->
  <div *ngIf="showEmployeeListView && isAdmin">
    <div *ngIf="loadingEmployees" class="loading">Loading employees...</div>
    <div *ngIf="error" class="error-message">{{ error }}</div>
    
    <div *ngIf="!loadingEmployees && employees.length === 0" class="no-data">
      <p>No employees found.</p>
    </div>

    <div *ngIf="!loadingEmployees && employees.length > 0" class="employee-table-container">
      <table class="employee-table">
        <thead>
          <tr>
            <th>Employee Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Job Title</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let employee of employees" class="employee-row">
            <td>{{ employee.fullName || employee.username || 'N/A' }}</td>
            <td>{{ employee.workEmail || 'N/A' }}</td>
            <td>{{ employee.departmentName || 'N/A' }}</td>
            <td>{{ employee.jobTitle || 'N/A' }}</td>
            <td>
              <button (click)="selectEmployee(employee)" class="btn btn-sm btn-primary">
                View Leaves
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Leave List View (shown when employee is selected or for regular users) -->
  <div *ngIf="!showEmployeeListView">

    <!-- Selected Employee Info -->
    <div *ngIf="selectedEmployee" class="selected-employee-info">
      <h3>Leaves for: {{ selectedEmployee.fullName || selectedEmployee.username }}</h3>
      <p class="employee-details">
        <span *ngIf="selectedEmployee.workEmail">Email: {{ selectedEmployee.workEmail }}</span>
        <span *ngIf="selectedEmployee.departmentName"> | Department: {{ selectedEmployee.departmentName }}</span>
        <span *ngIf="selectedEmployee.jobTitle"> | Job Title: {{ selectedEmployee.jobTitle }}</span>
      </p>
    </div>

    <div class="filter-section">
      <button
        class="filter-btn"
        [class.active]="filterStatus === 'ALL'"
        (click)="filterByStatus('ALL')">
        All Leaves
      </button>
      <button
        class="filter-btn filter-pending"
        [class.active]="filterStatus === 'PENDING'"
        (click)="filterByStatus('PENDING')">
        Pending
      </button>
      <button
        class="filter-btn filter-approved"
        [class.active]="filterStatus === 'APPROVED'"
        (click)="filterByStatus('APPROVED')">
        Approved
      </button>
      <button
        class="filter-btn filter-rejected"
        [class.active]="filterStatus === 'REJECTED'"
        (click)="filterByStatus('REJECTED')">
        Rejected
      </button>
    </div>

  <!-- Leave Balance Section (for Admins/Super Admins) -->
  <div *ngIf="isAdmin && !loadingLeaveBalances && employeeLeaveBalances.length > 0" class="leave-balance-section">
    <h3 class="section-title">üèñÔ∏è Employee Leave Balances</h3>
    <div class="leave-balance-grid">
      <div *ngFor="let employeeBalance of employeeLeaveBalances" class="employee-balance-group">
        <h4 class="employee-name">{{ employeeBalance.employeeName }}</h4>
        <div class="leave-balance-cards">
          <div *ngFor="let balance of employeeBalance.balances" class="leave-balance-card" 
               [ngClass]="getLeaveBalanceStatusClass(balance.remainingLeaves)">
            <div class="balance-header">
              <span class="balance-type">{{ balance.leaveType }}</span>
              <span class="balance-year">{{ balance.financialYear }}</span>
            </div>
            <div class="balance-details">
              <div class="balance-item">
                <span class="balance-label">Total Allocated:</span>
                <span class="balance-value">{{ balance.totalAllocated }} days</span>
              </div>
              <div class="balance-item">
                <span class="balance-label">Used:</span>
                <span class="balance-value used">{{ balance.usedLeaves }} days</span>
              </div>
              <div class="balance-item">
                <span class="balance-label">Remaining:</span>
                <span class="balance-value remaining" [ngClass]="getLeaveBalanceStatusClass(balance.remainingLeaves)">
                  {{ balance.remainingLeaves }} days
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leave Balance Section (for Regular Users - show own balance) -->
  <div *ngIf="!isAdmin && !loadingLeaveBalances && userLeaveBalances.length > 0" class="leave-balance-section">
    <h3 class="section-title">üèñÔ∏è Your Leave Balance</h3>
    <div class="leave-balance-grid">
      <div *ngFor="let balance of userLeaveBalances" class="leave-balance-card" 
           [ngClass]="getLeaveBalanceStatusClass(balance.remainingLeaves)">
        <div class="balance-header">
          <span class="balance-type">{{ balance.leaveType }}</span>
          <span class="balance-year">{{ balance.financialYear }}</span>
        </div>
        <div class="balance-details">
          <div class="balance-item">
            <span class="balance-label">Total Allocated:</span>
            <span class="balance-value">{{ balance.totalAllocated }} days</span>
          </div>
          <div class="balance-item">
            <span class="balance-label">Used:</span>
            <span class="balance-value used">{{ balance.usedLeaves }} days</span>
          </div>
          <div class="balance-item">
            <span class="balance-label">Remaining:</span>
            <span class="balance-value remaining" [ngClass]="getLeaveBalanceStatusClass(balance.remainingLeaves)">
              {{ balance.remainingLeaves }} days
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="loading" class="loading">Loading leaves...</div>

  <div *ngIf="!loading && leaves.length === 0" class="no-data">
    <p>No leave requests found.</p>
    <a routerLink="/leaves/apply" class="btn btn-primary">Apply for Leave</a>
  </div>

  <div *ngIf="!loading && leaves.length > 0" class="leave-table-container">
    <table class="leave-table">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Leave Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days</th>
          <th>Reason</th>
          <th>Status</th>
          <th>Applied Date</th>
          <th *ngIf="isAdmin">Approved By</th>
          <th *ngIf="isAdmin">Leave Balance</th>
          <th *ngIf="isSuperAdmin">Remarks</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let leave of leaves">
          <td>{{ leave.employeeName }}</td>
          <td>{{ leave.leaveType }}</td>
          <td>{{ leave.startDate | date: 'MMM dd, yyyy' }}</td>
          <td>{{ leave.endDate | date: 'MMM dd, yyyy' }}</td>
          <td class="text-center">{{ leave.numberOfDays }}</td>
          <td class="reason-cell">{{ leave.reason }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(leave.status!)">
              {{ leave.status }}
            </span>
          </td>
          <td>{{ leave.appliedDate | date: 'MMM dd, yyyy' }}</td>
          <td *ngIf="isAdmin">{{ leave.approvedBy || leave.rejectedBy || '-' }}</td>
          <td *ngIf="isAdmin" class="balance-cell">
            <span *ngIf="leave.remainingLeaves !== undefined && leave.totalAllocated !== undefined" 
                  [class.balance-low]="leave.remainingLeaves <= 2"
                  [class.balance-warning]="leave.remainingLeaves > 2 && leave.remainingLeaves <= 5">
              {{ leave.remainingLeaves }}/{{ leave.totalAllocated }}
            </span>
            <span *ngIf="leave.remainingLeaves === undefined || leave.totalAllocated === undefined">-</span>
          </td>
          <td *ngIf="isSuperAdmin" class="remarks-cell">
            {{ leave.remarks || '-' }}
          </td>
          <td class="actions-cell">
            <!-- SUPER_ADMIN actions -->
            <div *ngIf="isSuperAdmin" class="action-buttons">
              <button
                *ngIf="leave.status === 'PENDING'"
                (click)="openCommentModal(leave, 'APPROVE')"
                class="btn btn-sm btn-approve"
                title="Approve with Comments">
                ‚úÖ Approve
              </button>
              <button
                *ngIf="leave.status === 'PENDING'"
                (click)="openCommentModal(leave, 'REJECT')"
                class="btn btn-sm btn-reject"
                title="Reject with Comments">
                ‚ùå Reject
              </button>
              <button
                *ngIf="leave.status === 'PENDING'"
                (click)="openCommentModal(leave, 'REQUEST_UPDATE')"
                class="btn btn-sm btn-info"
                title="Request Update">
                üîÑ Request Update
              </button>
              <button
                (click)="openCommentModal(leave, 'COMMENT')"
                class="btn btn-sm btn-comment"
                title="Add Comment">
                üí¨ Comment
              </button>
              <button
                *ngIf="leave.hasHolidayForm"
                (click)="viewHolidayForm(leave)"
                class="btn btn-sm btn-info"
                title="View Holiday Form">
                üìÑ Holiday Form
              </button>
            </div>

            <!-- Regular ADMIN actions -->
            <div *ngIf="!isSuperAdmin">
              <button
                *ngIf="isAdmin && leave.status === 'PENDING'"
                (click)="approveLeave(leave)"
                class="btn btn-sm btn-approve"
                title="Approve Leave">
                Approve
              </button>
              <button
                *ngIf="isAdmin && leave.status === 'PENDING'"
                (click)="rejectLeave(leave)"
                class="btn btn-sm btn-reject"
                title="Reject Leave">
                Reject
              </button>
              <button
                *ngIf="canEdit(leave)"
                (click)="editLeave(leave)"
                class="btn btn-sm btn-edit"
                title="Edit Leave">
                Edit
              </button>
              <button
                *ngIf="canDelete(leave)"
                (click)="deleteLeave(leave)"
                class="btn btn-sm btn-delete"
                title="Delete Leave">
                Delete
              </button>
              <button
                *ngIf="leave.hasHolidayForm"
                (click)="viewHolidayForm(leave)"
                class="btn btn-sm btn-info"
                title="View Holiday Form">
                üìÑ Holiday Form
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Comment/Action Modal for SUPER_ADMIN -->
  <div *ngIf="showCommentModal" class="modal-overlay" (click)="closeCommentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <span *ngIf="actionType === 'APPROVE'">‚úÖ Approve Leave Request</span>
          <span *ngIf="actionType === 'REJECT'">‚ùå Reject Leave Request</span>
          <span *ngIf="actionType === 'COMMENT'">üí¨ Add Comment</span>
          <span *ngIf="actionType === 'REQUEST_UPDATE'">üîÑ Request Update</span>
        </h3>
        <button class="btn-close" (click)="closeCommentModal()">√ó</button>
      </div>

      <div class="modal-body" *ngIf="selectedLeave">
        <div class="leave-summary">
          <p><strong>Employee:</strong> {{ selectedLeave.employeeName }}</p>
          <p><strong>Leave Type:</strong> {{ selectedLeave.leaveType }}</p>
          <p><strong>Duration:</strong> {{ selectedLeave.startDate | date: 'MMM dd, yyyy' }} - {{ selectedLeave.endDate | date: 'MMM dd, yyyy' }} ({{ selectedLeave.numberOfDays }} days)</p>
          <p><strong>Reason:</strong> {{ selectedLeave.reason }}</p>
          <div *ngIf="isAdmin && selectedLeave.remainingLeaves !== undefined && selectedLeave.totalAllocated !== undefined" class="leave-balance-info">
            <p><strong>Leave Balance:</strong> 
              <span [class.balance-low]="selectedLeave.remainingLeaves <= 2"
                    [class.balance-warning]="selectedLeave.remainingLeaves > 2 && selectedLeave.remainingLeaves <= 5"
                    [class.balance-good]="selectedLeave.remainingLeaves > 5">
                {{ selectedLeave.remainingLeaves }} / {{ selectedLeave.totalAllocated }} remaining
              </span>
            </p>
            <p class="balance-detail">
              <small>Used: {{ selectedLeave.usedLeaves || 0 }} days | 
              Remaining: {{ selectedLeave.remainingLeaves }} days</small>
            </p>
          </div>
          <div *ngIf="selectedLeave.hasHolidayForm" class="holiday-form-section">
            <p><strong>Holiday Form:</strong></p>
            <button
              (click)="viewHolidayForm(selectedLeave)"
              class="btn btn-sm btn-info"
              title="View Holiday Form">
              üìÑ View Holiday Form
            </button>
          </div>
        </div>

        <div class="comment-section">
          <label for="comment">
            <span *ngIf="actionType === 'APPROVE'">Approval Comments:</span>
            <span *ngIf="actionType === 'REJECT'">Rejection Reason:</span>
            <span *ngIf="actionType === 'COMMENT'">Your Comment:</span>
            <span *ngIf="actionType === 'REQUEST_UPDATE'">Request Details:</span>
          </label>
          <textarea
            id="comment"
            [(ngModel)]="commentText"
            rows="5"
            class="form-control"
            [placeholder]="actionType === 'APPROVE' ? 'Enter approval comments...' :
                        actionType === 'REJECT' ? 'Enter rejection reason...' :
                        actionType === 'REQUEST_UPDATE' ? 'Explain what needs to be updated...' :
                        'Enter your comment...'"
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCommentModal()">Cancel</button>
        <button
          class="btn btn-primary"
          [disabled]="!commentText.trim()"
          (click)="submitComment()">
          <span *ngIf="actionType === 'APPROVE'">‚úÖ Approve</span>
          <span *ngIf="actionType === 'REJECT'">‚ùå Reject</span>
          <span *ngIf="actionType === 'COMMENT'">üí¨ Add Comment</span>
          <span *ngIf="actionType === 'REQUEST_UPDATE'">üîÑ Request Update</span>
        </button>
      </div>
    </div>
  </div>
  <!-- End Leave List View -->
</div>

