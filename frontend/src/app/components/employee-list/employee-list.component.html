<div class="employee-list-container">
  <div class="page-header">
    <h2>Employees</h2>
    <div class="header-actions">
      <a routerLink="/users/create" class="btn btn-success" *ngIf="currentUser?.roles?.includes('ADMIN') || currentUser?.roles?.includes('SUPER_ADMIN')">
        <span>üë§</span> Create User
      </a>
    </div>
  </div>

  <div *ngIf="loading" class="loading">Loading employees...</div>

  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="!loading && employees.length === 0 && totalElements === 0" class="no-data">
    No employees found. Click "Create User" to get started.
  </div>

  <!-- Main Content Layout: Table -->
  <div class="main-content-layout" *ngIf="!loading && (employees.length > 0 || totalElements > 0)">
    <!-- Table Content Area -->
    <div class="table-content-area">
      <!-- Global Search Filter -->
      <div class="global-search-container">
        <label for="globalSearch" class="global-search-label">Filter</label>
        <input
          type="text"
          id="globalSearch"
          class="global-search-input"
          placeholder="Search employees..."
          [(ngModel)]="globalSearchQuery"
          (input)="onGlobalSearchChange()"
        />
      </div>


      <div *ngIf="filteredEmployees.length === 0" class="no-results">
        <div class="no-results-icon">üîç</div>
        <p class="no-results-text">No employees match your search criteria</p>
        <button class="btn btn-secondary" (click)="clearFilters()">Clear Filters</button>
      </div>

      <table *ngIf="filteredEmployees.length > 0" class="employee-table">
        <thead>
          <tr>
            <th (click)="onSort('fullName')" class="sortable">
              <span>Full Name</span>
              <span class="sort-icon">{{ getSortIcon('fullName') }}</span>
            </th>
            <th (click)="onSort('username')" class="sortable">
              <span>Username</span>
              <span class="sort-icon">{{ getSortIcon('username') }}</span>
            </th>
            <th (click)="onSort('position')" class="sortable">
              <span>Position</span>
              <span class="sort-icon">{{ getSortIcon('position') }}</span>
            </th>
            <th (click)="onSort('department')" class="sortable">
              <span>Department</span>
              <span class="sort-icon">{{ getSortIcon('department') }}</span>
            </th>
            <th (click)="onSort('allottedOrganization')" class="sortable">
              <span>Allotted Organization</span>
              <span class="sort-icon">{{ getSortIcon('allottedOrganization') }}</span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let employee of filteredEmployees">
            <td data-label="Full Name">
              <div class="employee-name">
                <span class="name-icon">üë§</span>
                <strong>{{ employee.fullName }}</strong>
              </div>
            </td>
            <td data-label="Username">
              <span class="username-badge" *ngIf="employee.username">
                {{ employee.username }}
              </span>
              <span class="no-user" *ngIf="!employee.username">-</span>
            </td>
            <td data-label="Position">{{ employee.jobTitle || '-' }}</td>
            <td data-label="Department">
              <span class="department-badge" *ngIf="employee.departmentName">
                {{ employee.departmentName }}
              </span>
              <span *ngIf="!employee.departmentName">-</span>
            </td>
            <td data-label="Organization">
              <span class="org-badge" *ngIf="employee.allottedOrganization">
                {{ employee.allottedOrganization }}
              </span>
              <span *ngIf="!employee.allottedOrganization">-</span>
            </td>
            <td class="actions" data-label="">
              <button (click)="viewEmployeeDetails(employee.id!)" class="btn btn-details btn-sm" title="View Full Details">
                üëÅÔ∏è
              </button>
              <a [routerLink]="['/employees/edit', employee.id]" class="btn btn-edit btn-sm" title="Edit Employee">
                ‚úèÔ∏è
              </a>
              <button (click)="deleteEmployee(employee.id)" class="btn btn-delete btn-sm" title="Delete Employee">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="pagination-container" *ngIf="usePagination && totalElements > 0">
        <div class="pagination-left">
          <label for="itemsPerPage" class="pagination-label">Items per page:</label>
          <select 
            id="itemsPerPage"
            class="pagination-select" 
            [value]="pageSize" 
            (change)="onPageSizeChange(+$any($event.target).value)">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        
        <div class="pagination-center">
          <span class="pagination-range">
            {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }} of {{ totalElements }}
          </span>
        </div>
        
        <div class="pagination-right">
          <button 
            class="pagination-nav-btn"
            [disabled]="currentPage === 0"
            (click)="onPageChange(0)"
            title="First Page">
            |<
          </button>
          <button 
            class="pagination-nav-btn"
            [disabled]="currentPage === 0"
            (click)="onPageChange(currentPage - 1)"
            title="Previous Page">
            <
          </button>
          <button 
            class="pagination-nav-btn"
            [disabled]="currentPage >= totalPages - 1"
            (click)="onPageChange(currentPage + 1)"
            title="Next Page">
            >
          </button>
          <button 
            class="pagination-nav-btn"
            [disabled]="currentPage >= totalPages - 1"
            (click)="onPageChange(totalPages - 1)"
            title="Last Page">
            >|
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee Details Modal -->
  <div *ngIf="showDetailsModal" class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content employee-details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üë§ Employee Complete Details</h3>
        <button class="modal-close" (click)="closeDetailsModal()">√ó</button>
      </div>

      <div *ngIf="loadingDetails" class="modal-loading">
        <div class="spinner"></div>
        <p>Loading employee details...</p>
      </div>

      <div *ngIf="!loadingDetails && selectedEmployee" class="modal-body">
        <!-- Personal Information Section -->
        <div class="details-section">
          <h4 class="section-title">üìã Personal Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Full Name:</span>
              <span class="info-value">{{ selectedEmployee.fullName }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Person Type:</span>
              <span class="info-value">{{ selectedEmployee.personType }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Username:</span>
              <span class="info-value">
                <span class="username-badge" *ngIf="selectedEmployee.username">
                  {{ selectedEmployee.username }}
                </span>
                <span *ngIf="!selectedEmployee.username">-</span>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Work Email:</span>
              <span class="info-value">{{ selectedEmployee.workEmail }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Personal Email:</span>
              <span class="info-value">{{ selectedEmployee.personalEmail || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Phone:</span>
              <span class="info-value">{{ selectedEmployee.phoneNumber || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Date of Birth:</span>
              <span class="info-value">{{ selectedEmployee.dateOfBirth | date:'mediumDate' || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Nationality:</span>
              <span class="info-value">{{ selectedEmployee.nationality || '-' }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Registered Address:</span>
              <span class="info-value">{{ selectedEmployee.address || '-' }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Present Address:</span>
              <span class="info-value">{{ selectedEmployee.presentAddress || '-' }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Previous Address:</span>
              <span class="info-value">{{ selectedEmployee.previousAddress || '-' }}</span>
            </div>
          </div>
        </div>

        <!-- Employment Information Section -->
        <div class="details-section">
          <h4 class="section-title">üíº Employment Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Position:</span>
              <span class="info-value">{{ selectedEmployee.jobTitle || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Reference:</span>
              <span class="info-value">{{ selectedEmployee.reference || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Date of Joining:</span>
              <span class="info-value">{{ selectedEmployee.dateOfJoining | date:'mediumDate' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Employment Status:</span>
              <span class="info-value">{{ selectedEmployee.employmentStatus || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Contract Type:</span>
              <span class="info-value">{{ selectedEmployee.contractType || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Working Timing:</span>
              <span class="info-value">{{ selectedEmployee.workingTiming || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Holiday Allowance:</span>
              <span class="info-value">{{ selectedEmployee.holidayAllowance || '-' }} days</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Allotted Organization:</span>
              <span class="info-value">
                <span class="org-badge" *ngIf="selectedEmployee.allottedOrganization">
                  {{ selectedEmployee.allottedOrganization }}
                </span>
                <span *ngIf="!selectedEmployee.allottedOrganization">-</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Role & Department Section -->
        <div class="details-section">
          <h4 class="section-title">üîê Role & Department</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">User Role:</span>
              <span class="info-value">
                <span class="role-badge" *ngIf="selectedEmployee.role" [class]="'role-' + (selectedEmployee.role || '').toLowerCase()">
                  {{ selectedEmployee.role }}
                </span>
                <span *ngIf="!selectedEmployee.role">-</span>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Department:</span>
              <span class="info-value">
                <span class="department-badge" *ngIf="selectedEmployee.departmentName">
                  {{ selectedEmployee.departmentName }}
                </span>
                <span *ngIf="!selectedEmployee.departmentName">-</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Next of Kin Section -->
        <div class="details-section">
          <h4 class="section-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Next of Kin</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Name:</span>
              <span class="info-value">{{ selectedEmployee.nextOfKinName || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Contact:</span>
              <span class="info-value">{{ selectedEmployee.nextOfKinContact || '-' }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Address:</span>
              <span class="info-value">{{ selectedEmployee.nextOfKinAddress || '-' }}</span>
            </div>
          </div>
        </div>

        <!-- Previous Employment Section -->
        <div class="details-section">
          <h4 class="section-title">üìã Previous Employment</h4>
          <div class="employment-records-list" *ngIf="selectedEmployee.employmentRecords && selectedEmployee.employmentRecords.length > 0">
            <div *ngFor="let record of selectedEmployee.employmentRecords" class="employment-record-item">
              <div class="record-header">
                <strong>{{ record.jobTitle || 'Previous Position' }}</strong>
                <span class="record-period" *ngIf="record.employmentPeriod">{{ record.employmentPeriod }}</span>
              </div>
              <div class="record-details">
                <div *ngIf="record.employerName">
                  <span class="record-label">Employer:</span> {{ record.employerName }}
                </div>
                <div *ngIf="record.employerAddress">
                  <span class="record-label">Address:</span> {{ record.employerAddress }}
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!selectedEmployee.employmentRecords || selectedEmployee.employmentRecords.length === 0" class="no-data-small">
            No previous employment records
          </div>
        </div>

                <!-- Medical Information Section -->
                <div class="details-section">
                  <h4 class="section-title">ü©∫ Medical Information</h4>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="info-label">Blood Group:</span>
                      <span class="info-value">{{ selectedEmployee.bloodGroup || '-' }}</span>
                    </div>
                    <div class="info-item full-width">
                      <span class="info-label">Has Medical Condition:</span>
                      <span class="info-value">{{ selectedEmployee.hasMedicalCondition ? 'Yes' : 'No' }}</span>
                    </div>
                    <div class="info-item full-width" *ngIf="selectedEmployee.hasMedicalCondition">
                      <span class="info-label">Medical Condition Details:</span>
                      <span class="info-value">{{ selectedEmployee.medicalConditionDetails || 'Details not provided' }}</span>
                    </div>
                  </div>
                </div>

                <!-- Emergency Contact Section -->
                <div class="details-section" *ngIf="selectedEmployee.emergencyContactName || selectedEmployee.emergencyContactPhone">
                  <h4 class="section-title">üö® Emergency Contact</h4>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="info-label">Name:</span>
                      <span class="info-value">{{ selectedEmployee.emergencyContactName || '-' }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Phone:</span>
                      <span class="info-value">{{ selectedEmployee.emergencyContactPhone || '-' }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Relationship:</span>
                      <span class="info-value">{{ selectedEmployee.emergencyContactRelationship || '-' }}</span>
                    </div>
                  </div>
                </div>

        <!-- Working Hours Section -->
        <div class="details-section" *ngIf="employeeWorkSummary">
          <h4 class="section-title">‚è∞ Working Hours Summary</h4>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-label">This Week</div>
              <div class="stat-value">{{ employeeWorkSummary.totalHoursThisWeek || 0 }} hrs</div>
              <div class="stat-subtext">{{ employeeWorkSummary.daysWorkedThisWeek || 0 }} days worked</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-label">This Month</div>
              <div class="stat-value">{{ employeeWorkSummary.totalHoursThisMonth || 0 }} hrs</div>
              <div class="stat-subtext">{{ employeeWorkSummary.daysWorkedThisMonth || 0 }} days worked</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üéØ</div>
              <div class="stat-label">Current Status</div>
              <div class="stat-value status-badge" [class]="'status-' + (employeeWorkSummary.currentStatus || 'unknown').toLowerCase()">
                {{ (employeeWorkSummary.currentStatus || 'Unknown').replace('_', ' ') }}
              </div>
            </div>
          </div>

          <!-- Weekly Attendance -->
          <div class="weekly-attendance" *ngIf="employeeWorkSummary.weeklyAttendance && employeeWorkSummary.weeklyAttendance.length > 0">
            <h5>üìÖ This Week's Attendance</h5>
            <div class="attendance-list">
              <div *ngFor="let attendance of employeeWorkSummary.weeklyAttendance" class="attendance-row">
                <div class="attendance-date">
                  <span class="day">{{ attendance.workDate | date:'EEE' }}</span>
                  <span class="date">{{ attendance.workDate | date:'MMM d' }}</span>
                </div>
                <div class="attendance-location">
                  <span class="location-icon">üìç</span>
                  {{ attendance.workLocationDisplay }}
                </div>
                <div class="attendance-hours">
                  <span *ngIf="attendance.hoursWorked" class="hours-badge">
                    {{ attendance.hoursWorked.toFixed(2) }} hrs
                  </span>
                  <span *ngIf="!attendance.hoursWorked" class="in-progress-badge">
                    In Progress
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ROTA Schedule Section -->
        <div class="details-section" *ngIf="employeeRotaSchedule && employeeRotaSchedule.length > 0">
          <h4 class="section-title">üìã Current Week ROTA Schedule</h4>
          <div class="rota-timeline">
            <div *ngFor="let schedule of employeeRotaSchedule" class="rota-day" [class]="getDutyClass(schedule.duty)">
              <div class="rota-day-header">
                <span class="day-name">{{ schedule.dayOfWeek || schedule.date }}</span>
                <span class="day-date">{{ (schedule.scheduleDate || schedule.date) | date:'MMM d' }}</span>
              </div>
              <div class="rota-day-body">
                <div class="duty-name">{{ schedule.duty || 'No duty' }}</div>
                <div class="duty-time" *ngIf="schedule.startTime && schedule.endTime">
                  {{ schedule.startTime }} - {{ schedule.endTime }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents Section -->
        <div class="details-section">
          <h4 class="section-title">üìÑ Documents</h4>

          <!-- Document List -->
          <div *ngIf="employeeDocuments && employeeDocuments.length > 0" class="documents-section">
            <div class="documents-list">
              <div *ngFor="let doc of employeeDocuments"
                   class="document-item"
                   [class.selected]="selectedDocumentId === doc.id"
                   (click)="viewDocument(doc.id!, doc.documentType)">
                <div class="document-icon">
                  <span *ngIf="doc.documentType === 'PASSPORT'">üõÇ</span>
                  <span *ngIf="doc.documentType === 'VISA'">üìã</span>
                  <span *ngIf="doc.documentType === 'ID_CARD'">ü™™</span>
                  <span *ngIf="doc.documentType === 'DRIVING_LICENSE'">üöó</span>
                  <span *ngIf="doc.documentType === 'CONTRACT'">üìù</span>
                  <span *ngIf="!['PASSPORT', 'VISA', 'ID_CARD', 'DRIVING_LICENSE', 'CONTRACT'].includes(doc.documentType)">üìé</span>
                </div>
                <div class="document-info">
                  <div class="document-name">{{ doc.fileName }}</div>
                  <div class="document-meta">
                    <span class="document-type">{{ doc.documentType }}</span>
                    <span class="document-date">{{ doc.uploadedDate | date:'short' }}</span>
                  </div>

                  <!-- Show Full Name for Passport -->
                  <div class="document-extracted-info" *ngIf="doc.documentType === 'PASSPORT' && doc.fullName">
                    <span class="doc-info-label">üë§ Name:</span>
                    <span class="doc-info-value">{{ doc.fullName }}</span>
                  </div>


                  <div class="document-details" *ngIf="doc.documentNumber || doc.referenceNumber || doc.issueDate || doc.expiryDate || doc.dateOfCheck">
                    <span *ngIf="doc.documentNumber" class="doc-number">No: {{ doc.documentNumber }}</span>
                    <span *ngIf="doc.referenceNumber" class="doc-number">Ref: {{ doc.referenceNumber }}</span>
                    <span *ngIf="doc.expiryDate" class="doc-expiry">Exp: {{ doc.expiryDate | date:'mediumDate' }}</span>
                    <span *ngIf="doc.dateOfCheck" class="doc-check">Check: {{ doc.dateOfCheck | date:'mediumDate' }}</span>
                  </div>
                </div>
                <div class="document-actions">
                  <button (click)="viewDocument(doc.id!, doc.documentType); $event.stopPropagation()"
                          class="btn-icon"
                          title="View Document"
                          [class.active]="selectedDocumentId === doc.id">
                    üëÅÔ∏è
                  </button>
                  <button (click)="downloadDocument(doc.id!); $event.stopPropagation()"
                          class="btn-icon"
                          title="Download">
                    ‚¨áÔ∏è
                  </button>
                </div>
              </div>
            </div>

            <!-- Document Viewer -->
            <div *ngIf="selectedDocumentId" class="document-viewer">
              <div class="viewer-header">
                <h5>üìÑ Document Preview</h5>
                <button (click)="closeDocumentViewer()" class="btn-close-viewer" title="Close Viewer">√ó</button>
              </div>

              <!-- Loading State -->
              <div *ngIf="documentLoading" class="viewer-loading">
                <div class="spinner"></div>
                <p>Loading document...</p>
              </div>

              <!-- Smart Document Display -->
              <div *ngIf="!documentLoading && (selectedDocumentUrl || selectedDocumentRawUrl)" class="viewer-content">
                <!-- PDF Viewer (for PDF files) -->
                <div *ngIf="isSelectedDocPdf">
                  <div class="format-indicator">üìÑ PDF</div>
                  <object [data]="selectedDocumentUrl"
                          type="application/pdf"
                          class="document-pdf">
                    <div class="pdf-fallback">
                      <p>Unable to display PDF in browser.</p>
                    </div>
                  </object>
                </div>

                <!-- Image Viewer (for image files) -->
                <div *ngIf="isSelectedDocImage">
                  <div class="format-indicator image-indicator">üñºÔ∏è Image</div>
                  <img [src]="selectedDocumentRawUrl"
                       alt="Document"
                       class="document-image">
                </div>

                <!-- Fallback if type not detected -->
                <div *ngIf="!isSelectedDocPdf && !isSelectedDocImage" class="unknown-format">
                  <p>‚ö†Ô∏è Unable to preview this document format</p>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!employeeDocuments || employeeDocuments.length === 0" class="no-data-small">
            üì≠ No documents uploaded yet
          </div>

          <button (click)="uploadDocument(selectedEmployee.id!)" class="btn btn-primary btn-sm" style="margin-top: 1rem;">
            üì§ Upload Document
          </button>
        </div>

      </div>

      <div class="modal-footer">
        <button (click)="closeDetailsModal()" class="btn btn-secondary">Close</button>
        <a [routerLink]="['/employees/edit', selectedEmployee?.id]" (click)="closeDetailsModal()" class="btn btn-primary">
          ‚úèÔ∏è Edit Employee
        </a>
      </div>
    </div>
  </div>
</div>
